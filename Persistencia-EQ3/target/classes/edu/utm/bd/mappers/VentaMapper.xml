<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.utm.bd.mappers.VentaMapper">
  <resultMap id="BaseResultMap" type="edu.utm.bd.domain.Venta">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 25 18:12:03 CDT 2018.
    -->
    <id column="id_venta" jdbcType="INTEGER" property="idVenta" />
    <result column="id_cliente" jdbcType="INTEGER" property="idCliente" />
    <result column="id_producto" jdbcType="INTEGER" property="idProducto" />
    <result column="fecha" jdbcType="DATE" property="fecha" />
    <result column="num_venta" jdbcType="INTEGER" property="numVenta" />
    <result column="cantidad" jdbcType="INTEGER" property="cantidad" />
    <result column="precio_compra" jdbcType="DOUBLE" property="producto.precioCompra" />
    <result column="precio_venta" jdbcType="DOUBLE" property="producto.precioVenta" />
  </resultMap>
  
  <insert id="registrarVenta" parameterType="edu.utm.bd.domain.Venta">
  		INSERT INTO VENTA VALUES (#{idVenta},#{numVenta}, #{idCliente},#{idProducto},#{fecha},#{cantidad})
  </insert>
  
  <insert id="registroVenta" parameterType="edu.utm.bd.domain.Venta">
  		INSERT INTO VENTA(id_cliente,num_venta,id_producto,fecha,cantidad) VALUES ((SELECT id_cliente from cliente where nombre = #{nombre}),#{numVenta},(SELECT id_producto FROM producto where descripcion=#{descripcion} and tipo = #{tipo} and marca = #{marca} LIMIT 1),#{fecha},#{cantidad})
  </insert>
  
  <select id="findAllVentas" resultMap="BaseResultMap">
  	SELECT *FROM VENTA
  </select>
  
    <select id="findDay" parameterType="edu.utm.bd.domain.Venta" resultMap="BaseResultMap">
  	SELECT SUM( (producto.precio_venta-producto.precio_compra) * venta.cantidad ) AS ganancia, venta.fecha AS fecha, venta.num_venta AS numVenta FROM venta INNER JOIN producto ON venta.id_producto = producto.id_producto and fecha = #{fecha} GROUP BY venta.num_venta;
  </select>
  
  <select id="findWeek" parameterType="edu.utm.bd.domain.Venta" resultMap="BaseResultMap">
  	SELECT SUM( (producto.precio_venta-producto.precio_compra) * venta.cantidad ) AS ganancia, venta.fecha AS fecha, venta.num_venta AS numVenta FROM venta INNER JOIN producto ON venta.id_producto = producto.id_producto and  venta.fecha between #{fecha} and date_add(#{fecha}, interval 7 day) GROUP BY venta.num_venta;
  </select>
  <select id="findVenta" parameterType="edu.utm.bd.domain.Venta" resultMap="BaseResultMap">
  	SELECT producto.tipo AS tipo, producto.marca AS marca, (producto.precio_venta-producto.precio_compra) * venta.cantidad AS precioVenta,venta.fecha AS fecha, venta.cantidad AS cantidad FROM venta INNER JOIN producto ON venta.id_producto = producto.id_producto and venta.num_venta = #{numVenta};
  </select>
  
  <select id="findVentas" resultMap="BaseResultMap">
  	SELECT id_venta, fecha, descripcion,tipo,marca, precio_venta FROM VENTA v INNER JOIN PRODUCTO p where v.id_producto = p.id_producto ORDER BY fecha
  </select>
  
  <select id="encuentraMax" resultMap="BaseResultMap">
	SELECT MAX(id_venta) as idVenta FROM VENTA
  </select>
  
  <select id="encuentraNumVenta" resultMap="BaseResultMap" parameterType="integer">
	SELECT * FROM VENTA where id_venta=#{idVenta}
  </select>
  
</mapper>